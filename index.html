<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Essay Grader Demo</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    table, th, td {
      border: 1px solid #ddd;
    }
    th, td {
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f4f4f4;
    }
    textarea {
      width: 100%;
      resize: none;
    }
    .actions {
      text-align: center;
    }
    #predict_section {
      display: none;
    }
    button {
      margin: 5px 0;
    }
    /* Loading Screen Styles */
    #loading_screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .progress-bar-container {
      width: 80%;
      background-color: gray;
      margin: 10px;
    }
    .progress-bar {
      height: 24px;
      background-color: green;
      width: 0%;
    }
    .progress-text {
      font-size: 18px;
    }
  </style>
</head>
<body>
  <h1>AI Essay Grader Demo</h1>

  <div>
    <h2>Training Data</h2>
    <button onclick="addSubgradeColumn()">Add Subgrade</button>
    <button onclick="addEssayRow()">Add Essay</button>
    <table id="data_table">
      <thead>
        <tr>
          <th>Essay</th>
          <th>Main Grade</th>
          <th class="subgrade"><input type="text" value="Subgrade 1" onchange="updateSubgradeNames()"></th>
          <th class="subgrade"><input type="text" value="Subgrade 2" onchange="updateSubgradeNames()"></th>
          <th class="actions">Actions</th>
        </tr>
      </thead>
      <tbody>
        <!-- Essay rows will be added here -->
      </tbody>
    </table>
    <button onclick="trainModel()">Train Models</button>
    <div id="output"></div>
  </div>

  <div id="predict_section">
    <h2>Predict Grades</h2>
    <textarea id="new_essay_input" rows="4" placeholder="Enter an essay to predict the grades..."></textarea><br>
    <button onclick="predictGrade()">Predict</button>
    <div id="predicted_grade_output"></div>
  </div>

  <!-- Loading Screen -->
  <div id="loading_screen">
    <div class="progress-text" id="loading-text">Training in Progress...</div>
    <div class="progress-bar-container">
      <div class="progress-bar" id="progress-bar"></div>
    </div>
    <div class="progress-text" id="time-left">Estimated Time Left: Calculating...</div>
  </div>

  <script>
    const models = {
      mainGrade: null,
      subGrades: [],
    };

    let epochStartTime = 0;
    let totalEpochs = 0;

    function addEssayRow() {
      const tableBody = document.querySelector("#data_table tbody");
      const subgradeCount = document.querySelectorAll("#data_table thead th.subgrade").length;
      const row = document.createElement("tr");

      let subgradeInputs = "";
      for (let i = 0; i < subgradeCount; i++) {
        subgradeInputs += `<td><input type="number" placeholder="Subgrade"></td>`;
      }

      row.innerHTML = `
        <td><textarea rows="2" placeholder="Enter essay text"></textarea></td>
        <td><input type="number" placeholder="Main grade"></td>
        ${subgradeInputs}
        <td class="actions"><button onclick="removeRow(this)">Remove Essay</button></td>
      `;
      tableBody.appendChild(row);
    }

    function addSubgradeColumn() {
      const tableHead = document.querySelector("#data_table thead tr");
      const subgradeIndex = tableHead.querySelectorAll("th.subgrade").length + 1;
      const tableBodyRows = document.querySelectorAll("#data_table tbody tr");

      const subgradeHeader = document.createElement("th");
      subgradeHeader.classList.add("subgrade");
      subgradeHeader.innerHTML = `<input type="text" value="Subgrade ${subgradeIndex}" onchange="updateSubgradeNames()">`;
      tableHead.insertBefore(subgradeHeader, tableHead.querySelector(".actions"));

      tableBodyRows.forEach((row) => {
        const subgradeCell = document.createElement("td");
        subgradeCell.innerHTML = `<input type="number" placeholder="Subgrade">`;
        row.insertBefore(subgradeCell, row.querySelector(".actions"));
      });
    }

    function removeRow(button) {
      const row = button.closest("tr");
      row.remove();
    }

    function updateSubgradeNames() {
      const subgradeHeaders = document.querySelectorAll("#data_table thead th.subgrade input");
      const subgradeNames = Array.from(subgradeHeaders).map((input) => input.value.trim());
      console.log("Updated Subgrade Names:", subgradeNames);
    }

    async function trainModel() {
      const tableBodyRows = document.querySelectorAll("#data_table tbody tr");

      if (tableBodyRows.length < 8) {
        document.getElementById("output").textContent = "You need at least 8 essays to train the model.";
        return;
      }

      const essays = [];
      const mainGrades = [];
      const subGrades = [];

      tableBodyRows.forEach((row) => {
        const cells = row.querySelectorAll("td");
        essays.push(cells[0].querySelector("textarea").value);
        mainGrades.push(Number(cells[1].querySelector("input").value));
        const subgradeRow = [];
        for (let i = 2; i < cells.length - 1; i++) {
          subgradeRow.push(Number(cells[i].querySelector("input").value));
        }
        subGrades.push(subgradeRow);
      });

      const trainSize = Math.floor(essays.length * 0.75);
      const trainEssays = essays.slice(0, trainSize);
      const trainMainGrades = mainGrades.slice(0, trainSize);
      const trainSubGrades = subGrades.slice(0, trainSize);

      const testEssays = essays.slice(trainSize);
      const testMainGrades = mainGrades.slice(trainSize);
      const testSubGrades = subGrades.slice(trainSize);

      const vectorizedTrainEssays = vectorizeData(trainEssays);
      const vectorizedTestEssays = vectorizeData(testEssays);

      totalEpochs = 10;  // Set total number of epochs

      showLoadingScreen();

      models.mainGrade = createAndTrainModel(
        vectorizedTrainEssays,
        tf.tensor(trainMainGrades),
        vectorizedTestEssays,
        testMainGrades,
        'mainGrade'
      );

      models.subGrades = [];
      for (let i = 0; i < trainSubGrades[0].length; i++) {
        const subTrainGrades = trainSubGrades.map((row) => row[i]);
        const subTestGrades = testSubGrades.map((row) => row[i]);
        models.subGrades.push(
          createAndTrainModel(
            vectorizedTrainEssays,
            tf.tensor(subTrainGrades),
            vectorizedTestEssays,
            subTestGrades,
            `subGrade${i}`
          )
        );
      }

      document.getElementById("predict_section").style.display = "block";
      document.getElementById("output").textContent = "Models trained successfully.";
      hideLoadingScreen();
    }

    function showLoadingScreen() {
      document.getElementById("loading_screen").style.display = 'flex';
      epochStartTime = Date.now();  // Capture the starting time
    }

    function hideLoadingScreen() {
      document.getElementById("loading_screen").style.display = 'none';
    }

    function updateProgress(epoch, totalEpochs) {
      const elapsedTime = (Date.now() - epochStartTime) / 1000; // Time in seconds
      const timePerEpoch = elapsedTime / epoch;
      const remainingTime = timePerEpoch * (totalEpochs - epoch);
      
      document.getElementById("progress-bar").style.width = `${(epoch / totalEpochs) * 100}%`;
      document.getElementById("loading-text").textContent = `Epoch ${epoch} of ${totalEpochs}`;
      document.getElementById("time-left").textContent = `Estimated Time Left: ${formatTime(remainingTime)}`;
    }

    function formatTime(seconds) {
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const remainingSeconds = Math.floor(seconds % 60);
      return `${hours}h ${minutes}m ${remainingSeconds}s`;
    }

    function vectorizeData(data) {
      return data.map((item) => item.split(' ').map(word => word.length)); // Example
    }

   function createAndTrainModel(trainData, trainLabels, testData, testLabels, modelName) {
  const tensorTrainData = tf.tensor2d(trainData); // Convert to 2D tensor
  const tensorTestData = tf.tensor2d(testData);   // Convert to 2D tensor
  
  const model = tf.sequential();
  model.add(tf.layers.dense({ units: 64, inputShape: [tensorTrainData.shape[1]], activation: 'relu' }));
  model.add(tf.layers.dense({ units: 1 }));

  model.compile({ optimizer: 'adam', loss: 'meanSquaredError' });

  return model.fit(tensorTrainData, trainLabels, {
    epochs: totalEpochs,
    batchSize: 5,
    validationData: [tensorTestData, testLabels],
    callbacks: {
      onEpochEnd: (epoch, logs) => {
        updateProgress(epoch + 1, totalEpochs);
      }
    }
  });
}


    function predictGrade() {
      const essay = document.getElementById("new_essay_input").value;
      const vectorizedEssay = vectorizeData([essay]);

      const mainGradePrediction = models.mainGrade.predict(tf.tensor(vectorizedEssay)).arraySync()[0];
      let subGradePredictions = models.subGrades.map((model) => model.predict(tf.tensor(vectorizedEssay)).arraySync()[0]);

      document.getElementById("predicted_grade_output").innerHTML = `
        Main Grade: ${mainGradePrediction.toFixed(2)}<br>
        Subgrades: ${subGradePredictions.map((score) => score.toFixed(2)).join(', ')}
      `;
    }
  </script>
</body>
</html>
