<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Essay Grader Demo</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    table, th, td {
      border: 1px solid #ddd;
    }
    th, td {
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f4f4f4;
    }
    textarea {
      width: 100%;
      resize: none;
    }
    .actions {
      text-align: center;
    }
    #predict_section {
      display: none;
    }
    button {
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <h1>Dynamic Essay Grading Model</h1>

  <div>
    <h2>Training Data</h2>
    <button onclick="addSubgradeColumn()">Add Subgrade</button>
    <button onclick="addEssayRow()">Add Essay</button>
    <table id="data_table">
      <thead>
        <tr>
          <th>Essay</th>
          <th>Main Grade</th>
          <th class="subgrade"><input type="text" value="Subgrade 1" onchange="updateSubgradeNames()"></th>
          <th class="subgrade"><input type="text" value="Subgrade 2" onchange="updateSubgradeNames()"></th>
          <th class="actions">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><textarea rows="2">This is the first essay.</textarea></td>
          <td><input type="number" value="3" ></td>
          <td><input type="number" value="3" ></td>
          <td><input type="number" value="2" ></td>
          <td class="actions">
            <button onclick="removeRow(this)">Remove Essay</button>
          </td>
        </tr>
        <tr>
          <td><textarea rows="2">This is the second essay.</textarea></td>
          <td><input type="number" value="4" ></td>
          <td><input type="number" value="4" ></td>
          <td><input type="number" value="3" ></td>
          <td class="actions">
            <button onclick="removeRow(this)">Remove Essay</button>
          </td>
        </tr>
      </tbody>
    </table>
    <button onclick="trainModel()">Train Models</button>
    <div id="output"></div>
  </div>

  <div id="predict_section">
    <h2>Predict Grades</h2>
    <textarea id="new_essay_input" rows="4" placeholder="Enter an essay to predict the grades..."></textarea><br>
    <button onclick="predictGrade()">Predict</button>
    <div id="predicted_grade_output"></div>
  </div>

  <script>
    const models = {
      mainGrade: null,
      subGrades: [],
    };

    function addEssayRow() {
      const tableBody = document.querySelector("#data_table tbody");
      const subgradeCount = document.querySelectorAll("#data_table thead th.subgrade").length; // Calculate the number of subgrades
      const row = document.createElement("tr");

      let subgradeInputs = "";
      for (let i = 0; i < subgradeCount; i++) {
        subgradeInputs += `<td><input type="number"  placeholder="Subgrade"></td>`;
      }

      row.innerHTML = `
        <td><textarea rows="2" placeholder="Enter essay text"></textarea></td>
        <td><input type="number"  placeholder="Main grade"></td>
        ${subgradeInputs}
        <td class="actions"><button onclick="removeRow(this)">Remove Essay</button></td>
      `;
      tableBody.appendChild(row);
    }

    function addSubgradeColumn() {
      const tableHead = document.querySelector("#data_table thead tr");
      const subgradeIndex = tableHead.querySelectorAll("th.subgrade").length + 1;
      const tableBodyRows = document.querySelectorAll("#data_table tbody tr");

      // Add column header
      const subgradeHeader = document.createElement("th");
      subgradeHeader.classList.add("subgrade");
      subgradeHeader.innerHTML = `<input type="text" value="Subgrade ${subgradeIndex}" onchange="updateSubgradeNames()">`;
      tableHead.insertBefore(subgradeHeader, tableHead.querySelector(".actions"));

      // Add column to each row
      tableBodyRows.forEach((row) => {
        const subgradeCell = document.createElement("td");
        subgradeCell.innerHTML = `<input type="number"  placeholder="Subgrade">`;
        row.insertBefore(subgradeCell, row.querySelector(".actions"));
      });
    }

    function removeRow(button) {
      const row = button.closest("tr");
      row.remove();
    }

    function updateSubgradeNames() {
      const subgradeHeaders = document.querySelectorAll("#data_table thead th.subgrade input");
      const subgradeNames = Array.from(subgradeHeaders).map((input) => input.value.trim());

      console.log("Updated Subgrade Names:", subgradeNames); // Debugging log
      // Update references to subgrade names if needed in the app logic
    }

    async function trainModel() {
      const tableBodyRows = document.querySelectorAll("#data_table tbody tr");

      if (tableBodyRows.length < 8) {
        document.getElementById("output").textContent = "You need at least 8 essays to train the model.";
        return;
      }

      // Prepare data
      const essays = [];
      const mainGrades = [];
      const subGrades = [];

      tableBodyRows.forEach((row) => {
        const cells = row.querySelectorAll("td");
        essays.push(cells[0].querySelector("textarea").value);
        mainGrades.push(Number(cells[1].querySelector("input").value));
        const subgradeRow = [];
        for (let i = 2; i < cells.length - 1; i++) {
          subgradeRow.push(Number(cells[i].querySelector("input").value));
        }
        subGrades.push(subgradeRow);
      });

      const trainSize = Math.floor(essays.length * 0.75);
      const trainEssays = essays.slice(0, trainSize);
      const trainMainGrades = mainGrades.slice(0, trainSize);
      const trainSubGrades = subGrades.slice(0, trainSize);

      const testEssays = essays.slice(trainSize);
      const testMainGrades = mainGrades.slice(trainSize);
      const testSubGrades = subGrades.slice(trainSize);

      // Vectorize essays
      const vectorizedTrainEssays = vectorizeData(trainEssays);
      const vectorizedTestEssays = vectorizeData(testEssays);

      // Train main grade model
      models.mainGrade = createAndTrainModel(
        vectorizedTrainEssays,
        tf.tensor(trainMainGrades),
        vectorizedTestEssays,
        testMainGrades
      );

      // Train subgrade models
      models.subGrades = [];
      for (let i = 0; i < trainSubGrades[0].length; i++) {
        const subTrainGrades = trainSubGrades.map((row) => row[i]);
        const subTestGrades = testSubGrades.map((row) => row[i]);
        models.subGrades.push(
          createAndTrainModel(
            vectorizedTrainEssays,
            tf.tensor(subTrainGrades),
            vectorizedTestEssays,
            subTestGrades
          )
        );
      }

      document.getElementById("predict_section").style.display = "block";
      document.getElementById("output").textContent = "Models trained successfully.";
    }

    function vectorizeData(data, maxLength = 24) {
      return tf.tensor(
        data.map((essay) => {
          const charCodes = Array.from(essay)
            .map((char) => char.charCodeAt(0) % 128)
            .slice(0, maxLength); // Truncate to maxLength
          while (charCodes.length < maxLength) {
            charCodes.push(0); // Pad with zeros
          }
          return charCodes;
        })
      );
    }

    function createAndTrainModel(trainX, trainY, testX, testY) {
      const model = tf.sequential();
      model.add(tf.layers.dense({ inputShape: [trainX.shape[1]], units: 16, activation: "relu" }));
      model.add(tf.layers.dense({ units: 8, activation: "relu" }));
      model.add(tf.layers.dense({ units: 1, activation: "linear" }));
      model.compile({ optimizer: "adam", loss: "meanSquaredError" });

      model
        .fit(trainX, trainY, { epochs: 10, validationData: [testX, testY], verbose: 0 })
        .then(() => console.log("Model trained successfully."));

      return model;
    }

    async function predictGrade() {
      const essay = document.getElementById("new_essay_input").value;

      if (!essay.trim()) {
        document.getElementById("predicted_grade_output").textContent = "Enter an essay to predict grades.";
        return;
      }

      const vectorizedEssay = vectorizeData([essay]);

      const mainGradePrediction = await models.mainGrade.predict(vectorizedEssay).data();
      const subGradePredictions = await Promise.all(
        models.subGrades.map((model) => model.predict(vectorizedEssay).data())
      );

      const predictedSubGrades = subGradePredictions.map((pred) => Math.round(pred[0]));
      const predictedMainGrade = Math.round(mainGradePrediction[0]);

      document.getElementById("predicted_grade_output").innerHTML = `
        <strong>Predicted Main Grade:</strong> ${predictedMainGrade}<br>
        <strong>Predicted Subgrades:</strong> ${predictedSubGrades.join(", ")}
      `;
    }
  </script>
</body>
</html>
