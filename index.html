<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dynamic Essay Grading</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    table, th, td {
      border: 1px solid #ddd;
    }
    th, td {
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f4f4f4;
    }
    textarea {
      width: 100%;
      resize: none;
    }
    .actions {
      text-align: center;
    }
    #predict_section {
      display: none;
    }
    button {
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <h1>Dynamic Essay Grading Model</h1>

  <div>
    <h2>Training Data</h2>
    <button onclick="addSubgradeColumn()">Add Subgrade</button>
    <button onclick="addEssayRow()">Add Essay</button>
    <table id="data_table">
      <thead>
        <tr>
          <th>Essay</th>
          <th>Main Grade</th>
          <th>Subgrade 1</th>
          <th>Subgrade 2</th>
          <th class="actions">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><textarea rows="2">This is the first essay.</textarea></td>
          <td><input type="number" value="3" min="1" max="4"></td>
          <td><input type="number" value="3" min="1" max="4"></td>
          <td><input type="number" value="2" min="1" max="4"></td>
          <td class="actions">
            <button onclick="removeRow(this)">Remove Essay</button>
          </td>
        </tr>
        <tr>
          <td><textarea rows="2">This is the second essay.</textarea></td>
          <td><input type="number" value="4" min="1" max="4"></td>
          <td><input type="number" value="4" min="1" max="4"></td>
          <td><input type="number" value="3" min="1" max="4"></td>
          <td class="actions">
            <button onclick="removeRow(this)">Remove Essay</button>
          </td>
        </tr>
      </tbody>
    </table>
    <button onclick="trainModel()">Train Models</button>
    <div id="output"></div>
  </div>

  <div id="predict_section">
    <h2>Predict Grades</h2>
    <textarea id="new_essay_input" rows="4" placeholder="Enter an essay to predict the grades..."></textarea><br>
    <button onclick="predictGrade()">Predict</button>
    <div id="predicted_grade_output"></div>
  </div>

  <script>
    const models = {
      mainGrade: null,
      subGrades: [],
    };

    function addEssayRow() {
      const tableBody = document.querySelector("#data_table tbody");
      const subgradeCount = document.querySelector("#data_table thead tr th").length - 3;
      const row = document.createElement("tr");

      row.innerHTML = `
        <td><textarea rows="2" placeholder="Enter essay text"></textarea></td>
        <td><input type="number" min="1" max="4" placeholder="Main grade"></td>
        ${'<td><input type="number" min="1" max="4" placeholder="Subgrade"></td>'.repeat(subgradeCount)}
        <td class="actions"><button onclick="removeRow(this)">Remove Essay</button></td>
      `;
      tableBody.appendChild(row);
    }

    function addSubgradeColumn() {
      const tableHead = document.querySelector("#data_table thead tr");
      const subgradeIndex = tableHead.querySelectorAll("th").length - 2;
      const tableBodyRows = document.querySelectorAll("#data_table tbody tr");

      // Add column header
      const subgradeHeader = document.createElement("th");
      subgradeHeader.textContent = `Subgrade ${subgradeIndex}`;
      tableHead.insertBefore(subgradeHeader, tableHead.querySelector(".actions"));

      // Add column to each row
      tableBodyRows.forEach((row) => {
        const subgradeCell = document.createElement("td");
        subgradeCell.innerHTML = `<input type="number" min="1" max="4" placeholder="Subgrade">`;
        row.insertBefore(subgradeCell, row.querySelector(".actions"));
      });
    }

    function removeRow(button) {
      const row = button.closest("tr");
      row.remove();
    }

    async function trainModel() {
      const tableBodyRows = document.querySelectorAll("#data_table tbody tr");

      if (tableBodyRows.length < 8) {
        document.getElementById("output").textContent = "You need at least 8 essays to train the model.";
        return;
      }

      // Prepare data
      const essays = [];
      const mainGrades = [];
      const subGrades = [];

      tableBodyRows.forEach((row) => {
        const cells = row.querySelectorAll("td");
        essays.push(cells[0].querySelector("textarea").value);
        mainGrades.push(Number(cells[1].querySelector("input").value));
        const subgradeRow = [];
        for (let i = 2; i < cells.length - 1; i++) {
          subgradeRow.push(Number(cells[i].querySelector("input").value));
        }
        subGrades.push(subgradeRow);
      });

      const trainSize = Math.floor(essays.length * 0.75);
      const trainEssays = essays.slice(0, trainSize);
      const trainMainGrades = mainGrades.slice(0, trainSize);
      const trainSubGrades = subGrades.slice(0, trainSize);

      const testEssays = essays.slice(trainSize);
      const testMainGrades = mainGrades.slice(trainSize);
      const testSubGrades = subGrades.slice(trainSize);

      // Vectorize essays
      const vectorizedTrainEssays = vectorizeData(trainEssays);
      const vectorizedTestEssays = vectorizeData(testEssays);

      // Train main grade model
      models.mainGrade = createAndTrainModel(
        vectorizedTrainEssays,
        tf.tensor(trainMainGrades),
        vectorizedTestEssays,
        testMainGrades
      );

      // Train subgrade models
      models.subGrades = [];
      for (let i = 0; i < trainSubGrades[0].length; i++) {
        const subTrainGrades = trainSubGrades.map((row) => row[i]);
        const subTestGrades = testSubGrades.map((row) => row[i]);
        models.subGrades.push(
          createAndTrainModel(
            vectorizedTrainEssays,
            tf.tensor(subTrainGrades),
            vectorizedTestEssays,
            subTestGrades
          )
        );
      }

      document.getElementById("predict_section").style.display = "block";
      document.getElementById("output").textContent = "Models trained successfully.";
    }

    function vectorizeData(data) {
      return tf.tensor(data.map((essay) => Array.from(essay).map((char) => char.charCodeAt(0) % 128)));
    }

    function createAndTrainModel(trainX, trainY, testX, testY) {
      const model = tf.sequential();
      model.add(tf.layers.dense({ inputShape: [trainX.shape[1]], units: 128, activation: "relu" }));
      model.add(tf.layers.dense({ units: 64, activation: "relu" }));
      model.add(tf.layers.dense({ units: 1, activation: "linear" }));
      model.compile({ optimizer: "adam", loss: "meanSquaredError" });

      let epochCount = 0;
      let consecutiveCorrect = 0;

      model.fit(trainX, trainY, {
        epochs: 100,
        validationData: [testX, tf.tensor(testY)],
        callbacks: {
          onEpochEnd: async (epoch, logs) => {
            epochCount++;
            const preds = model.predict(testX).arraySync().map((val) => Math.round(val));
            const correct = preds.every((pred, i) => pred === testY[i]);
            if (correct) {
              consecutiveCorrect++;
            } else {
              consecutiveCorrect = 0;
            }

            if (consecutiveCorrect >= 4) {
              model.stopTraining = true;
            }
          },
        },
      });

      return model;
    }

    function predictGrade() {
      const essay = document.getElementById("new_essay_input").value;
      const vectorizedEssay = vectorizeData([essay]);

      const mainGrade = models.mainGrade.predict(vectorizedEssay).arraySync()[0][0].toFixed(2);
      const subGrades = models.subGrades.map((model) =>
        model.predict(vectorizedEssay).arraySync()[0][0].toFixed(2)
      );

      const output = `
        <p>Main Grade: ${mainGrade}</p>
        ${subGrades.map((subGrade, i) => `<p>Subgrade ${i + 1}: ${subGrade}</p>`).join("")}
      `;
      document.getElementById("predicted_grade_output").innerHTML = output;
    }
  </script>
</body>
</html>
