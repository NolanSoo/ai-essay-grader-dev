<!DOCTYPE html>
<html>
  <head>
    <title>AI Essay Grader Demo</title>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css" />
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.4.0"></script>
  </head>

  <body>
    <h1>AI Essay Grader</h1>
    <h2>Revised Solution Trials (Prompt 2)</h2>
    <div id="app"></div>
    <div class="w3-black">
      <div
        class="w3-container w3-green w3-center"
        id="loading_bar"
        style="width: 0%"
      >
        <p id="percentage_label">0%</p>
        <break>
          <p id="time_label"></p>
      </div>
    </div>
    <h1></h1>
    <div id="wrapper" align="center">
      <break>
      <table
        align="center"
        cellspacing="2"
        cellpadding="5"
        id="data_table"
        border="1"
      >
        <tr>
          <th>Essay</th>
          <th>Main Grade</th>
          <th>Actions</th>
        </tr>

        <tr id="row1">
          <td id="essay_row1">This is a terrblie essay</td>
          <td id="grade_row1">1</td>
          <td>
            <input
              type="button"
              value="Remove Essay"
              class="delete"
              onclick="delete_row('1')"
            />
          </td>
        </tr>

        <tr id="row2">
          <td id="essay_row2">This is an excellent essay.</td>
          <td id="grade_row2">4</td>
          <td>
            <input
              type="button"
              value="Remove Essay"
              class="delete"
              onclick="delete_row('2')"
            />
          </td>
        </tr>

        <tr>
          <td><input type="text" id="new_name" /></td>
          <td><input type="text" id="new_country" /></td>
          <td>
            <input
              type="button"
              class="add"
              onclick="add_row();"
              value="Add Essay"
            />
          </td>
        </tr>
      </table>
        <!-- Add this below the table -->
<input type="button" value="Add New Subgrade Column" onclick="addNewSubgradeColumn()" />

      <h3>Playground/Demo</h3>
        <h4>Please copy and paste your graded essays (straight from Docs, Word, etc) - no rubric is required!</h4>
      <input
        type="button"
        id="train_model"
        value="Start Playground Model"
        onclick="trainModel()"
      />
      <div id="output"></div>
    </div>
    <div id="predict_section" style="display: none; margin-top: 20px">
      <h3>Enter a new essay to predict its grade:</h3>
      <textarea
        id="new_essay_input"
        rows="4"
        cols="50"
        placeholder="Type your essay here..."
      ></textarea>
      <br />
      <input
        type="button"
        id="predict_grade"
        value="Predict Grade"
        onclick="predictGrade()"
      />
      <div id="predicted_grade_output"></div>
      <div id="subgrades_section">
  <h3>Subgrades:</h3>
  <div id="subgrades_outputs"></div>
</div>

    </div>
    <script>
var finalModel; // Model for main grade
var subgradeModels = []; // Array to store models for subgrades

// Function to update progress during training (no change needed)
function updateProgress(percentage, totalTimeTaken) {
  percentage = Math.max(0, Math.min(100, percentage));
  percentage = percentage.toFixed(2);

  const loadingBar = document.getElementById("loading_bar");
  const percentageLabel = document.getElementById("percentage_label");

  loadingBar.style.width = percentage + "%";
  percentageLabel.textContent = percentage + "%";

  if (percentage > 0) {
    const elapsedTime = totalTimeTaken;
    const expectedTotalTime = elapsedTime / (percentage / 100);
    const remainingTime = expectedTotalTime - elapsedTime;
    const formatTime = (timeInSeconds) => {
      const minutes = Math.floor(timeInSeconds / 60);
      const seconds = Math.floor(timeInSeconds % 60);
      return `${minutes} minutes - ${seconds.toString().padStart(2, "0")} seconds`;
    };

    const timeTaken = formatTime(elapsedTime);
    const totalTime = formatTime(expectedTotalTime);

    const timeLabel = document.getElementById("time_label");
    timeLabel.textContent = `${timeTaken} / ${totalTime}`;
  }
}

// Function to preprocess essays
function preprocessText(essays) {
  const tokenizedInputs = essays.map((essay) => {
    const words = essay.trim().split(/\s+/);
    const vector = new Array(1200).fill(0);
    for (let word of words) {
      const index = Math.min(word.length, 1199);
      vector[index] += 1;
    }
    return vector;
  });
  return tf.tensor2d(tokenizedInputs);
}

// Function to add a new subgrade column
// Function to add a new subgrade column
function addNewSubgradeColumn() {
  const table = document.getElementById("data_table");
  const headersRow = table.querySelector("tr");

  // Add header for new subgrade column
  const th = document.createElement("th");
  th.innerText = "Subgrade " + (headersRow.cells.length - 2); // Automatically number the new column
  headersRow.appendChild(th);

  // Add input field for new subgrade prediction
  const rows = table.querySelectorAll("tr:not(:first-child)");
  rows.forEach((row) => {
    const td = document.createElement("td");
    td.innerHTML = "<input type='text' class='subgrade_input' />";
    row.appendChild(td);
  });

  // Create a new model for this subgrade
  const newSubgradeModel = createSubgradeModel();
  subgradeModels.push(newSubgradeModel);
}

// Function to train the models
async function trainModels() {
  const learningRate = 0.005;
  var percentageDone = 0;
  var totalTimeTaken = 0;
  var startTime = Date.now() / 1000;
  var currentTime = 0;

  const mainGradeInputEssays = [];
  const mainGradeTargets = [];
  const subgradeInputs = Array(subgradeModels.length).fill([]); // Array to hold subgrade inputs

  // Collect data from table rows
  const rows = document.querySelectorAll("#data_table tr:not(:first-child)");
  rows.forEach((row) => {
    const essay = row.querySelector("td:nth-child(1)").innerText.trim();
    const mainGrade = parseInt(row.querySelector("td:nth-child(2)").innerText.trim(), 10);

    mainGradeInputEssays.push(essay);
    mainGradeTargets.push(mainGrade);

    // Collect subgrade inputs
    subgradeModels.forEach((model, index) => {
      const subgradeInput = row.querySelectorAll("td")[index + 2].querySelector("input").value;
      subgradeInputs[index].push(subgradeInput ? parseInt(subgradeInput, 10) : 0);
    });
  });

  const mainGradeInputTrainTensor = preprocessText(mainGradeInputEssays);
  const mainGradeTargetTrainTensor = tf.tensor1d(mainGradeTargets);

  // Train main grade model
  finalModel = tf.sequential();
  finalModel.add(tf.layers.dense({ inputShape: [1200], units: 1 }));
  finalModel.compile({ optimizer: tf.train.adam(learningRate), loss: "meanSquaredError" });

  // Train the model for each subgrade
  subgradeModels.forEach((subgradeModel, index) => {
    const subgradeTensor = tf.tensor1d(subgradeInputs[index]);
    subgradeModel.fit(mainGradeInputTrainTensor, subgradeTensor, {
      epochs: 3000,
      verbose: 0,
    });
  });

  // Train the main grade model as well
  await finalModel.fit(mainGradeInputTrainTensor, mainGradeTargetTrainTensor, {
    epochs: 3000,
    verbose: 0,
  });

  console.log("Model training completed!");
  document.getElementById("output").innerText = "Model training completed!";
  document.getElementById("predict_section").style.display = "block";
}

// Function to predict grade and subgrades
async function predictGrade() {
  const essayInput = document.getElementById("new_essay_input").value.trim();

  if (!essayInput) {
    alert("Please enter an essay to predict the grade.");
    return;
  }

  const essayTensor = preprocessText([essayInput]);

  if (!finalModel) {
    alert("The model is not trained yet. Please train the model before predicting.");
    return;
  }

  // Predict main grade
  const prediction = await finalModel.predict(essayTensor).data();
  const predictedMainGrade = prediction[0];
  document.getElementById("predicted_grade_output").innerText = `Predicted Grade: ${predictedMainGrade}`;

  // Predict subgrades
  subgradeModels.forEach((subgradeModel, index) => {
    const subgradePrediction = await subgradeModel.predict(essayTensor).data();
    document.getElementById(`subgrade_output_${index}`).innerText = `Subgrade ${index + 1}: ${subgradePrediction[0]}`;
  });
}

document.getElementById("predict_grade").addEventListener("click", predictGrade);

// i know this is worst syntax of all time :(
      function edit_row(no) {
        document.getElementById("edit_button" + no).style.display = "none";

        var essayCell = document.getElementById("essay_row" + no);
        var gradeCell = document.getElementById("grade_row" + no);

        var essayData = essayCell.innerHTML;
        var gradeData = gradeCell.innerHTML;

        essayCell.innerHTML =
          "<input type='text' id='essay_text" +
          no +
          "' value='" +
          essayData +
          "'>";
        gradeCell.innerHTML =
          "<input type='text' id='grade_text" +
          no +
          "' value='" +
          gradeData +
          "'>";
      }

      // Modify the save_row function
      function save_row(no) {
        var essayVal = document.getElementById("essay_text" + no).value;
        var gradeVal = document.getElementById("grade_text" + no).value;

        document.getElementById("name_row" + no).innerHTML = essayVal;
        document.getElementById("country_row" + no).innerHTML = gradeVal;

        document.getElementById("edit_button" + no).style.display = "block";
      }

     function add_row() {
  var newEssay = document.getElementById("new_name").value;
  var newGrade = document.getElementById("new_country").value;

  // Assuming that the row ID should increment correctly based on total rows
  var table = document.getElementById("data_table");
  var tableLen = table.rows.length - 1; // Excluding header
  var row = table.insertRow(tableLen);

  // Set up the Essay cell and Grade cell
  var essayCell = row.insertCell(0);
  var gradeCell = row.insertCell(1);

  essayCell.innerHTML = newEssay;
  gradeCell.innerHTML = newGrade;

  // Add input fields for subgrades if any columns exist
  subgradeModels.forEach((subgradeModel, index) => {
    var subgradeCell = row.insertCell(index + 2);
    subgradeCell.innerHTML = "<input type='text' class='subgrade_input' />";
  });

  // Add Actions cell with Edit, Save, and Delete buttons
  var actionsCell = row.insertCell(-1);
  actionsCell.innerHTML =
    "<input type='button' value='Edit' class='edit' onclick='edit_row(" +
    (tableLen + 1) +
    ")'> " +
    "<input type='button' value='Save' class='save' onclick='save_row(" +
    (tableLen + 1) +
    ")'> " +
    "<input type='button' value='Delete' class='delete' onclick='delete_row(" +
    (tableLen + 1) +
    ")'>";

  document.getElementById("new_name").value = "";
  document.getElementById("new_country").value = "";
}

      function delete_row(no) {
  document.getElementById("row" + no).remove(); // Use remove() instead of outerHTML for deleting the row
}
    </script>
     <script src="index.js"></script>
    <div id="output"></div>
  </body>
</html>
