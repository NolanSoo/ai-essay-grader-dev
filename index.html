<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dynamic Essay Grading</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    table, th, td {
      border: 1px solid #ddd;
    }
    th, td {
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f4f4f4;
    }
    textarea {
      width: 100%;
      resize: none;
    }
    .actions {
      text-align: center;
    }
    #predict_section {
      display: none;
    }
    button {
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <h1>Dynamic Essay Grading Model</h1>

  <div>
    <h2>Training Data</h2>
    <button onclick="addSubgradeColumn()">Add Subgrade</button>
    <button onclick="addEssayRow()">Add Essay</button>
    <table id="data_table">
      <thead>
        <tr>
          <th>Essay</th>
          <th>Main Grade</th>
          <th>Subgrade 1</th>
          <th>Subgrade 2</th>
          <th class="actions">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><textarea rows="2">This is the first essay.</textarea></td>
          <td><input type="number" value="85"></td>
          <td><input type="number" value="90"></td>
          <td><input type="number" value="80"></td>
          <td class="actions">
            <button onclick="removeRow(this)">Remove Essay</button>
          </td>
        </tr>
        <tr>
          <td><textarea rows="2">This is the second essay.</textarea></td>
          <td><input type="number" value="75"></td>
          <td><input type="number" value="70"></td>
          <td><input type="number" value="65"></td>
          <td class="actions">
            <button onclick="removeRow(this)">Remove Essay</button>
          </td>
        </tr>
      </tbody>
    </table>
    <button onclick="trainModel()">Train Models</button>
    <div id="output"></div>
  </div>

  <div id="predict_section">
    <h2>Predict Grades</h2>
    <textarea id="new_essay_input" rows="4" placeholder="Enter an essay to predict the grades..."></textarea><br>
    <button onclick="predictGrade()">Predict</button>
    <div id="predicted_grade_output"></div>
  </div>

  <script>
    const models = {
      mainGrade: null,
      subGrades: [],
    };

    function addEssayRow() {
      const tableBody = document.querySelector("#data_table tbody");
      const subgradeCount = document.querySelector("#data_table thead tr th").length - 3;
      const row = document.createElement("tr");

      row.innerHTML = `
        <td><textarea rows="2" placeholder="Enter essay text"></textarea></td>
        <td><input type="number" placeholder="Main grade"></td>
        ${'<td><input type="number" placeholder="Subgrade"></td>'.repeat(subgradeCount)}
        <td class="actions"><button onclick="removeRow(this)">Remove Essay</button></td>
      `;
      tableBody.appendChild(row);
    }

    function addSubgradeColumn() {
      const tableHead = document.querySelector("#data_table thead tr");
      const subgradeIndex = tableHead.querySelectorAll("th").length - 2;
      const tableBodyRows = document.querySelectorAll("#data_table tbody tr");

      // Add column header
      const subgradeHeader = document.createElement("th");
      subgradeHeader.textContent = `Subgrade ${subgradeIndex}`;
      tableHead.insertBefore(subgradeHeader, tableHead.querySelector(".actions"));

      // Add column to each row
      tableBodyRows.forEach((row) => {
        const subgradeCell = document.createElement("td");
        subgradeCell.innerHTML = `<input type="number" placeholder="Subgrade">`;
        row.insertBefore(subgradeCell, row.querySelector(".actions"));
      });
    }

    function removeRow(button) {
      const row = button.closest("tr");
      row.remove();
    }

    async function trainModel() {
      const learningRate = 0.005;

      function preprocessText(essays) {
        return tf.tensor2d(
          essays.map((essay) => {
            const vector = new Array(1200).fill(0);
            essay
              .split(/\s+/)
              .forEach((word) => (vector[Math.min(word.length, 1199)] += 1));
            return vector;
          })
        );
      }

      const tableBodyRows = document.querySelectorAll("#data_table tbody tr");
      const essays = [];
      const mainGrades = [];
      const subGrades = [];

      tableBodyRows.forEach((row) => {
        const essay = row.querySelector("textarea").value.trim();
        const mainGrade = parseFloat(row.querySelector("td:nth-child(2) input").value);
        const subgradeCells = row.querySelectorAll("td:nth-child(n+3):not(:last-child) input");

        if (essay && !isNaN(mainGrade)) {
          essays.push(essay);
          mainGrades.push(mainGrade);
          subgradeCells.forEach((cell, index) => {
            if (!subGrades[index]) subGrades[index] = [];
            const subGrade = parseFloat(cell.value);
            subGrades[index].push(!isNaN(subGrade) ? subGrade : 0);
          });
        }
      });

      const inputTensor = preprocessText(essays);
      const mainGradeTensor = tf.tensor1d(mainGrades);

      // Train main grade model
      models.mainGrade = tf.sequential();
      models.mainGrade.add(tf.layers.dense({ inputShape: [1200], units: 1 }));
      models.mainGrade.compile({ optimizer: tf.train.adam(learningRate), loss: "meanSquaredError" });
      await models.mainGrade.fit(inputTensor, mainGradeTensor, { epochs: 10 });

      // Train subgrade models
      models.subGrades = subGrades.map((subGradeData) => {
        const model = tf.sequential();
        model.add(tf.layers.dense({ inputShape: [1200], units: 1 }));
        model.compile({ optimizer: tf.train.adam(learningRate), loss: "meanSquaredError" });

        const subGradeTensor = tf.tensor1d(subGradeData);
        model.fit(inputTensor, subGradeTensor, { epochs: 10 });
        return model;
      });

      document.getElementById("output").textContent = "Models trained successfully!";
      document.getElementById("predict_section").style.display = "block";
    }

    async function predictGrade() {
      const essay = document.getElementById("new_essay_input").value.trim();
      if (!essay) return alert("Enter an essay to predict grades.");

      const essayTensor = tf.tensor2d([
        new Array(1200).fill(0).map((_, i) => essay.split(/\s+/).filter((word) => word.length === i).length),
      ]);

      const mainGrade = await models.mainGrade.predict(essayTensor).data();
      const subGrades = await Promise.all(
        models.subGrades.map((model) => model.predict(essayTensor).data())
      );

      document.getElementById("predicted_grade_output").innerText = `
        Predicted Main Grade: ${mainGrade[0].toFixed(2)}
        ${subGrades.map((sg, i) => `Subgrade ${i + 1}: ${sg[0].toFixed(2)}`).join("\n")}
      `;
    }
  </script>
</body>
</html>
